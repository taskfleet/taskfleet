name: CI - Service Genesis
on:
  push:
    branches: [main]
  pull_request:
    paths:
      - services/genesis/**
      - packages/dymant/**
      - packages/eagle/**
      - packages/jack/**
      - packages/mercury/**
      - packages/postgres/**
      - .github/workflows/svc-genesis.yml

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Run tests
        uses: ./.github/actions/go-test
        with:
          path: services/genesis/internal
          flag: genesis

  integration-tests:
    name: Integration Tests
    needs: unit-tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    concurrency: # overwrite concurrency group as integration tests must be properly torn down
      group: ${{ github.workflow }}-${{ github.sha }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Authenticate with GCP
        id: gcp-auth
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - name: Run tests
        uses: ./.github/actions/go-test
        with:
          path: services/genesis/internal
          tags: integration
          flag: genesis
        env:
          GCP_PROJECT: ${{ steps.gcp-auth.outputs.project_id }}
